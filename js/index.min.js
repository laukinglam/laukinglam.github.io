"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function stripOld(){for(var a=arguments.length<=0||void 0===arguments[0]?1e3:arguments[0],b=Date.now(),c=0,d=ACTIVE_ELECTRONS.length;c<d;c++){var e=ACTIVE_ELECTRONS[c];e.expireAt-b<a&&(ACTIVE_ELECTRONS.splice(c,1),c--,d--)}}function createRandomCell(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(!(ACTIVE_ELECTRONS.length>=MAX_ELECTRONS)){var b=mainLayer.width,c=mainLayer.height,d=new Cell(_.random(c/CELL_DISTANCE),_.random(b/CELL_DISTANCE),a);d.paintNextTo(mainLayer)}}function drawGrid(){bgLayer.paint(function(a,b){var c=b.width,d=b.height;a.fillStyle=BG_COLOR,a.fillRect(0,0,c,d),a.fillStyle=BORDER_COLOR;for(var e=CELL_SIZE;e<d;e+=CELL_DISTANCE)a.fillRect(0,e,c,BORDER_WIDTH);for(var f=CELL_SIZE;f<c;f+=CELL_DISTANCE)a.fillRect(f,0,BORDER_WIDTH,d)})}function iterateItemsIn(a){for(var b=Date.now(),c=0,d=a.length;c<d;c++){var e=a[c];b>=e.expireAt?(a.splice(c,1),c--,d--):e.paintNextTo(mainLayer)}}function drawItems(){iterateItemsIn(PINNED_CELLS),iterateItemsIn(ACTIVE_ELECTRONS)}function activateRandom(){var a=Date.now();a<nextRandomAt||(nextRandomAt=a+_.random(300,1e3),createRandomCell())}function handlePointer(){function c(b,c){var d=a,e=d[0],f=d[1];return a=[b,c],b===e&&c===f}function d(a,b){var d=b.clientX,e=b.clientY,f=Math.floor(e/CELL_DISTANCE),g=Math.floor(d/CELL_DISTANCE);if(!a||!c(f,g)){var h=new Cell(f,g,{background:CELL_HIGHLIGHT,forceElectrons:!0,electronCount:a?2:4,electronOptions:{speed:3,lifeTime:a?500:1e3,color:CELL_HIGHLIGHT}});h.paintNextTo(mainLayer)}}function f(a){return Array.from(a).filter(function(a){var c=a.identifier,d=a.clientX,e=a.clientY,f=b[c];return b[c]={clientX:d,clientY:e},!f||d!==f.clientX||e!==f.clientY})}var a=[],b={},e={touchend:function(c){var d=c.changedTouches;d?Array.from(d).forEach(function(a){var c=a.identifier;delete b[c]}):b={}}};["mousedown","touchstart","mousemove","touchmove"].forEach(function(a){var b=/move/.test(a),c=/touch/.test(a),g=d.bind(null,b);e[a]=function(b){c?f(b.touches).forEach(g):g(b)}});var g=Object.keys(e);return g.forEach(function(a){document.addEventListener(a,e[a])}),function(){g.forEach(function(a){document.removeEventListener(a,e[a])})}}function prepaint(){drawGrid(),mainLayer.paint(function(a,b){var c=b.width,d=b.height;a.fillStyle="#fff",a.fillRect(0,0,c,d)}),mainLayer.blendBackground(bgLayer.canvas,.9)}function render(){mainLayer.blendBackground(bgLayer.canvas),drawItems(),activateRandom(),shape.renderID=requestAnimationFrame(render)}function queue(){var a="default text",b=0,c=a.length,d=function d(){b>=c||(shape.print(a.slice(0,++b)),timer=setTimeout(d,1e3+b))};d()}function countdown(){var a=_.range(3,0,-1),b=0,c=a.length,d=function d(){return b>=c?(shape.clear(),galaxy()):(shape.print(a[b++]),void setTimeout(d,1e3+b))};d()}function galaxy(){shape.spiral({radius:0,increment:1,lifeTime:100,electronCount:1}),timer=setTimeout(galaxy,16)}function ring(){shape.spiral(),timer=setTimeout(ring,16)}var _extends=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d])}return a},STEP_LENGTH=1,CELL_SIZE=10,BORDER_WIDTH=2,MAX_FONT_SIZE=500,MAX_ELECTRONS=100,CELL_DISTANCE=CELL_SIZE+BORDER_WIDTH,CELL_REPAINT_INTERVAL=[300,500],BG_COLOR="#1A0B20",BORDER_COLOR="#13191f",CELL_HIGHLIGHT="#328bf6",ELECTRON_COLOR="#00b07c",FONT_COLOR="#fff",FONT_FAMILY='"Blackadder ITC", Helvetica, Arial, "Hiragino Sans GB", "Microsoft YaHei", "WenQuan Yi Micro Hei", sans-serif',DPR=window.devicePixelRatio||1,ACTIVE_ELECTRONS=[],PINNED_CELLS=[],MOVE_TRAILS=[[0,1],[0,-1],[1,0],[-1,0]].map(function(a){var b=a[0],c=a[1];return[b*CELL_DISTANCE,c*CELL_DISTANCE]}),END_POINTS_OFFSET=[[0,0],[0,1],[1,0],[1,1]].map(function(a){var b=a[0],c=a[1];return[b*CELL_DISTANCE-BORDER_WIDTH/2,c*CELL_DISTANCE-BORDER_WIDTH/2]}),FullscreenCanvas=function(){function a(){var b=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];_classCallCheck(this,a);var c=document.createElement("canvas"),d=c.getContext("2d");this.canvas=c,this.context=d,this.disableScale=b,this.resizeHandlers=[],this.handleResize=_.debounce(this.handleResize.bind(this),100),this.adjust(),window.addEventListener("resize",this.handleResize)}return a.prototype.adjust=function(){var b=this.canvas,c=this.context,d=this.disableScale,e=window,f=e.innerWidth,g=e.innerHeight;this.width=f,this.height=g;var h=d?1:DPR;this.realWidth=b.width=f*h,this.realHeight=b.height=g*h,b.style.width=f+"px",b.style.height=g+"px",c.scale(h,h)},a.prototype.clear=function(){var b=this.context;b.clearRect(0,0,this.width,this.height)},a.prototype.makeCallback=function(b){b(this.context,this)},a.prototype.blendBackground=function(b){var c=arguments.length<=1||void 0===arguments[1]?.05:arguments[1];return this.paint(function(a,d){var e=d.realWidth,f=d.realHeight,g=d.width,h=d.height;a.globalCompositeOperation="source-over",a.globalAlpha=c,a.drawImage(b,0,0,e,f,0,0,g,h)})},a.prototype.paint=function(b){if(_.isFunction(b)){var c=this.context;return c.save(),this.makeCallback(b),c.restore(),this}},a.prototype.repaint=function(b){if(_.isFunction(b))return this.clear(),this.paint(b)},a.prototype.onResize=function(b){_.isFunction(b)&&this.resizeHandlers.push(b)},a.prototype.handleResize=function(){var b=this.resizeHandlers;b.length&&(this.adjust(),b.forEach(this.makeCallback.bind(this)))},a.prototype.renderIntoView=function(){var b=arguments.length<=0||void 0===arguments[0]?document.body:arguments[0],c=this.canvas;this.container=b,c.style.position="absolute",c.style.left="0px",c.style.top="0px",b.appendChild(c)},a.prototype.remove=function(){if(this.container)try{window.removeEventListener("resize",this.handleResize),this.container.removeChild(this.canvas)}catch(a){}},a}(),Electron=function(){function a(){var b=arguments.length<=0||void 0===arguments[0]?0:arguments[0],c=arguments.length<=1||void 0===arguments[1]?0:arguments[1],d=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],e=d.lifeTime,f=void 0===e?3e3:e,g=d.speed,h=void 0===g?STEP_LENGTH:g,i=d.color,j=void 0===i?ELECTRON_COLOR:i;_classCallCheck(this,a),this.lifeTime=f,this.expireAt=Date.now()+f,this.speed=h,this.color=j,this.radius=BORDER_WIDTH/2,this.current=[b,c],this.visited={},this.setDest(this.randomPath())}return a.prototype.randomPath=function(){var b=this.current,c=b[0],d=b[1],e=MOVE_TRAILS.length,f=MOVE_TRAILS[_.random(e-1)],g=f[0],h=f[1];return[c+g,d+h]},a.prototype.composeCoord=function(b){return b.join(",")},a.prototype.hasVisited=function(b){var c=this.composeCoord(b);return this.visited[c]},a.prototype.setDest=function(b){this.destination=b,this.visited[this.composeCoord(b)]=!0},a.prototype.next=function(){var b=this.speed,c=this.current,d=this.destination;if(Math.abs(c[0]-d[0])<=b/2&&Math.abs(c[1]-d[1])<=b/2){d=this.randomPath();for(var e=1,f=4;this.hasVisited(d)&&e<=f;)e++,d=this.randomPath();this.setDest(d)}var g=d[0]-c[0],h=d[1]-c[1];return g&&(c[0]+=g/Math.abs(g)*b),h&&(c[1]+=h/Math.abs(h)*b),[].concat(this.current)},a.prototype.paintNextTo=function(){var b=arguments.length<=0||void 0===arguments[0]?new FullscreenCanvas:arguments[0],c=this.radius,d=this.color,e=this.expireAt,f=this.lifeTime,g=this.next(),h=g[0],i=g[1];b.paint(function(a){a.globalAlpha=Math.max(0,e-Date.now())/f,a.fillStyle=d,a.shadowColor=d,a.shadowBlur=5*c,a.globalCompositeOperation="lighter",a.beginPath(),a.arc(h,i,c,0,2*Math.PI),a.closePath(),a.fill()})},a}(),Cell=function(){function a(){var b=arguments.length<=0||void 0===arguments[0]?0:arguments[0],c=arguments.length<=1||void 0===arguments[1]?0:arguments[1],d=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],e=d.electronCount,f=void 0===e?_.random(1,4):e,g=d.background,h=void 0===g?ELECTRON_COLOR:g,i=d.forceElectrons,j=void 0!==i&&i,k=d.electronOptions,l=void 0===k?{}:k;_classCallCheck(this,a),this.background=h,this.electronOptions=l,this.forceElectrons=j,this.electronCount=Math.min(f,4),this.startY=b*CELL_DISTANCE,this.startX=c*CELL_DISTANCE}return a.prototype.delay=function(){var b=arguments.length<=0||void 0===arguments[0]?0:arguments[0];this.pin(1.5*b),this.nextUpdate=Date.now()+b},a.prototype.pin=function(){var b=arguments.length<=0||void 0===arguments[0]?-1>>>1:arguments[0];this.expireAt=Date.now()+b,PINNED_CELLS.push(this)},a.prototype.scheduleUpdate=function(){var b=arguments.length<=0||void 0===arguments[0]?CELL_REPAINT_INTERVAL[0]:arguments[0],c=arguments.length<=1||void 0===arguments[1]?CELL_REPAINT_INTERVAL[1]:arguments[1];this.nextUpdate=Date.now()+_.random(b,c)},a.prototype.paintNextTo=function(){var b=arguments.length<=0||void 0===arguments[0]?new FullscreenCanvas:arguments[0],c=this.startX,d=this.startY,e=this.background,f=this.nextUpdate;f&&Date.now()<f||(this.scheduleUpdate(),this.createElectrons(),b.paint(function(a){a.globalCompositeOperation="lighter",a.fillStyle=e,a.fillRect(c,d,CELL_SIZE,CELL_SIZE)}))},a.prototype.popRandom=function(){var b=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],c=_.random(b.length-1);return b.splice(c,1)[0]},a.prototype.createElectrons=function(){var b=this.startX,c=this.startY,d=this.electronCount,e=this.electronOptions,f=this.forceElectrons;if(d)for(var g=[].concat(END_POINTS_OFFSET),h=f?d:Math.min(d,MAX_ELECTRONS-ACTIVE_ELECTRONS.length),i=0;i<h;i++){var j=this.popRandom(g),k=j[0],l=j[1];ACTIVE_ELECTRONS.push(new Electron(b+k,c+l,e))}},a}(),bgLayer=new FullscreenCanvas,mainLayer=new FullscreenCanvas,shapeLayer=new FullscreenCanvas((!0)),nextRandomAt=void 0,shape={lastText:"",lastMatrix:null,renderID:void 0,isAlive:!1,get electronOptions(){return{speed:2,color:FONT_COLOR,lifeTime:_.random(300,500)}},get cellOptions(){return{background:FONT_COLOR,electronCount:_.random(1,4),electronOptions:this.electronOptions}},get explodeOptions(){return _extends({},this.cellOptions,{electronOptions:_extends({},this.electronOptions,{lifeTime:_.random(500,1500)})})},init:function(){var b=this,c=arguments.length<=0||void 0===arguments[0]?document.body:arguments[0];this.isAlive||(bgLayer.onResize(drawGrid),mainLayer.onResize(prepaint),mainLayer.renderIntoView(c),shapeLayer.onResize(function(){b.lastText&&b.print(b.lastText)}),prepaint(),render(),this.unbindEvents=handlePointer(),this.isAlive=!0)},clear:function(){var b=this.lastMatrix;this.lastText="",this.lastMatrix=null,PINNED_CELLS.length=0,b&&this.explode(b)},destroy:function(){this.isAlive&&(bgLayer.remove(),mainLayer.remove(),shapeLayer.remove(),this.unbindEvents(),cancelAnimationFrame(this.renderID),ACTIVE_ELECTRONS.length=PINNED_CELLS.length=0,this.lastMatrix=null,this.lastText="",this.isAlive=!1)},getTextMatrix:function(b){var c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],d=c.fontWeight,e=void 0===d?"bold":d,f=c.fontFamily,g=void 0===f?FONT_FAMILY:f,h=shapeLayer.width,i=shapeLayer.height;shapeLayer.repaint(function(a){a.textAlign="center",a.textBaseline="middle",a.font=e+" "+MAX_FONT_SIZE+"px "+g;var c=h/a.measureText(b).width,d=Math.min(MAX_FONT_SIZE,MAX_FONT_SIZE*c*.8);a.font=e+" "+d+"px "+g,a.fillText(b,h/2,i/2)});for(var j=shapeLayer.context.getImageData(0,0,h,i).data,k=[],l=0;l<i;l+=CELL_DISTANCE)for(var m=0;m<h;m+=CELL_DISTANCE){var n=j[4*(m+l*h)+3];n>0&&k.push([Math.floor(l/CELL_DISTANCE),Math.floor(m/CELL_DISTANCE)])}return k},print:function(b,c){var d=this,e=!!this.lastText;if(this.clear(),0!==b&&!b)return void(e&&this.spiral({reverse:!0,lifeTime:500,electronCount:2}));this.spiral(),this.lastText=b;var f=this.lastMatrix=_.shuffle(this.getTextMatrix(b,c));f.forEach(function(a){var b=a[0],c=a[1],e=new Cell(b,c,d.cellOptions);e.scheduleUpdate(200),e.pin()})},spiral:function(){for(var b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],c=b.radius,d=b.increment,e=void 0===d?0:d,f=b.reverse,g=void 0!==f&&f,h=b.lifeTime,i=void 0===h?250:h,j=b.electronCount,k=void 0===j?1:j,l=b.forceElectrons,m=void 0===l||l,n=mainLayer.width,o=mainLayer.height,p=Math.floor(n/CELL_DISTANCE),q=Math.floor(o/CELL_DISTANCE),r=Math.floor(p/2),s=Math.floor(q/2),t=1,u=_.random(360),v=void 0===c?Math.floor(Math.min(p,q)/3):c,w=g?15:-15,x=Math.abs(360/w);t<=x;){var y=s+Math.floor(v*Math.sin(u/180*Math.PI)),z=r+Math.floor(v*Math.cos(u/180*Math.PI)),A=new Cell(y,z,{electronCount:k,forceElectrons:m,background:CELL_HIGHLIGHT,electronOptions:{lifeTime:i,speed:3,color:CELL_HIGHLIGHT}});A.delay(16*t),t++,u+=w,v+=e}},explode:function(b){if(stripOld(),b)for(var c=b.length,d=Math.min(50,_.random(Math.floor(c/20),Math.floor(c/10))),e=0;e<d;e++){var f=b[e],g=f[0],h=f[1],i=new Cell(g,h,this.explodeOptions);i.paintNextTo(mainLayer)}else for(var d=_.random(10,20),e=0;e<d;e++)createRandomCell(this.explodeOptions)}},timer=void 0;shape.init(),shape.print("M"),document.addEventListener("touchmove",function(a){return a.preventDefault()});